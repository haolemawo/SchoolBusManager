@{
    ViewData["Title"] = "学生签到";
    string SignMode = (string)ViewData["SignMode"];
    string ButtonArrays = "";
    string LSString = "\"<div class=\\\"col\\\"><button id=\\\"\" + TMP.ObjectId + \"_Leave\\\" style=\\\"width: 100%\\\" class=\\\"btn \" + (Leaved ? \"btn-success \" : \"btn-danger \") + \"btn-sm\\\" onClick=\\\"Sign('\" + TMP.ObjectId + \"', 'leave', '\" + !Leaved + \"')\\\">\" + (Leaved ? \"\u53D6\u6D88\" : \"\u79BB\u6821\") + \"</button></div>\"";
    string CSString = "\"<div class=\\\"col\\\"><button id=\\\"\" + TMP.ObjectId + \"_Come\\\" style=\\\"width: 100%\\\" class=\\\"btn \" + (Came ? \"btn-success \" : \"btn-danger \") + \"btn-sm\\\" onClick=\\\"Sign('\" + TMP.ObjectId + \"', 'come', '\" + !Came + \"')\\\">\" + (Came ? \"\u53D6\u6D88\" : \"\u8FD4\u6821\") + \"</button></div>\"";
    if (SignMode == "LS")
    {
        ButtonArrays = LSString;
    }
    else if (SignMode == "CS")
    {
        ButtonArrays = CSString;
    }
    else if (SignMode == "CD")
    {
        ButtonArrays = LSString + "+" + CSString;
    }
}
<div class="container">
    <div class="container row">
        <div class="col col-auto">
            <img id="UserHImg" src="#" width="64" height="64" alt="" />
        </div>
        <div class="col">
            <h5 id="UserID">加载中...</h5>
            <h6 id="BusDirection"></h6>
        </div>
    </div>
    <br />
    <div class="container">
        <p>以下数据将每10秒刷新一次：</p>
        <p id="TimeoutLabel">刷新时间：10</p>
        @if (SignMode == "LS" || SignMode == "CD")
        {
            <p id="LSChecked">离校签到人数: 加载中...</p>
        }
        @if (SignMode == "CS" || SignMode == "CD")
        {
            <p id="CSChecked">返校签到人数: 加载中...</p>
        }
        <p id="ExpNumber">校车总人数: 加载中...</p>
    </div>
    <hr>
    <div id="Students" class="container" style="font-size: small"></div>
</div>

<script>
    {
        var CurrentBus = wbWeb.GetMgmtBus();
        var totalStudents = wbWeb.GetStudents(CurrentBus.Bus.ObjectId, wbWeb.CurrentUser.ObjectId);
        var BustimeoutHandle = setInterval(MotherFunction, 1000);
        document.getElementById("UserID").innerHTML = "你好，" + wbWeb.CurrentUser.RealName;
        $("#UserHImg").prop("src", "https://res.lhy0403.top/WBUserHeadImg/" + wbWeb.CurrentUser.HeadImagePath);

        $("#ExpNumber").text("校车总人数: " + totalStudents.Count);
        $("#BusDirection").text("我的校车: " + CurrentBus.Bus.BusName);
        $("#LSChecked").text("离校签到人数: " + CurrentBus.LSChecked);
        $("#AHChecked").text("到家确认人数: " + CurrentBus.AHChecked);
        $("#CSChecked").text("返校签到人数: " + CurrentBus.CSChecked);
        for (var i = 0; i < totalStudents.Count; i++) {
            var TMP = totalStudents.StudentList[i];
            var Content =
                "<div id='" + TMP.ObjectId + "' class=\"row\"><div class=\"col\"><p class='text-underline' >" + "<a href=\"/BusManager/ViewStudent?StudentID=" + TMP.ObjectId + "&ClassID=" + TMP.ClassID + "&from=BusManager&BusID=" + TMP.BusID + "\">" + TMP.StudentName + "</a></p></div>";
            var Came = TMP.CSChecked, Leaved = TMP.LSChecked;
            Content = Content + @Html.Raw(ButtonArrays);
            Content = Content + "</div>";
            $("#Students").append(Content);
        }

        var TOut = 0;
        function MotherFunction() {
            $("#TimeoutLabel").text("刷新时间：" + TOut);
            if (TOut === 0) {
                $("#TimeoutLabel").text("刷新时间：正在刷新");
                $("#LSChecked").text("离校签到人数: 加载中...");
                $("#CSChecked").text("返校签到人数: 加载中...");
                CurrentBus = wbWeb.GetMgmtBus();
                $("#LSChecked").text("离校签到人数: " + CurrentBus.LSChecked);
                $("#CSChecked").text("返校签到人数: " + CurrentBus.CSChecked);
                TOut = 10;
            }
            TOut--;
        }

        function Sign(StudentID, Mode, value)
        {
            var data = wbWeb.SignStudent(CurrentBus.Bus.ObjectId, StudentID, Mode, value);

            if (data.SignMode === "come")
            {
                var rst = data.Student.CSChecked;
                $("#" + data.Student.ObjectId + "_Come").attr("class", "btn " + (rst ? "btn-success " : "btn-danger ") + "btn-sm");
                $("#" + data.Student.ObjectId + "_Come").text(rst ? "取消" : "返校");
                $("#" + data.Student.ObjectId + "_Come").attr("onclick", "Sign('" + data.Student.ObjectId + "', 'come', '" + !rst + "')");
            }
            else if (data.SignMode === "leave")
            {
                var rst = data.Student.LSChecked;
                $("#" + data.Student.ObjectId + "_Leave").attr("class", "btn " + (rst ? "btn-success " : "btn-danger ") + "btn-sm");
                $("#" + data.Student.ObjectId + "_Leave").text(rst ? "取消" : "离校");
                $("#" + data.Student.ObjectId + "_Leave").attr("onclick", "Sign('" + data.Student.ObjectId + "', 'leave', '" + !rst + "')");
            }
        }


        function ViewStudent(StudentID)
        {
            location.href = "/BusManager/ViewStudent?StudentID=" + StudentID;
        }
    }
</script>

